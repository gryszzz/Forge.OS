<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ForgeOS</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      const isLocal = ["localhost", "127.0.0.1"].includes(window.location.hostname);
      const repoBase = "/Forge.OS";

      async function fetchManifest() {
        const candidates = [
          { url: `${repoBase}/manifest.json`, base: `${repoBase}/` },
          { url: `${repoBase}/dist/manifest.json`, base: `${repoBase}/dist/` },
        ];

        for(const c of candidates) {
          const res = await fetch(c.url, { cache: "no-store" });
          if(res.ok) return { manifest: await res.json(), base: c.base };
        }

        throw new Error("Manifest fetch failed in both Actions and branch deployment paths");
      }

      async function boot() {
        if(isLocal) {
          await import("/src/main.tsx");
          return;
        }

        const { manifest, base } = await fetchManifest();
        const entry =
          manifest?.["src/main.tsx"]?.file ||
          manifest?.["index.html"]?.file ||
          Object.values(manifest || {}).find((v) => v && (v.isEntry || v.isDynamicEntry))?.file;

        if(!entry) throw new Error("Could not resolve app entry from manifest");

        await import(`${base}${entry}`);
      }

      boot().catch((err) => {
        console.error("ForgeOS bootstrap failed", err);
        document.body.innerHTML = "<div style='padding:24px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:#eee;background:#0a0a0a;min-height:100vh'>ForgeOS failed to load. Check GitHub Pages source and build artifact paths.</div>";
      });
    </script>
  </body>
</html>
